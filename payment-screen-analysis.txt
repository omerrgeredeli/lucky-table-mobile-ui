===========================================
PAYMENT SCREEN - KAMERA AÃ‡ILMAMA SORUNU ANALÄ°ZÄ°
===========================================

TARÄ°H: 2025-01-11
PROJE: Lucky Table Mobile UI
EXPO SDK: 51.0.0
REACT NATIVE: 0.74.5

===========================================
1. PAYMENT SCREEN ANA DOSYA
===========================================
Dosya: src/screens/payment/PaymentScreen.js
Toplam SatÄ±r: 562

import React, { useState, useEffect, useRef } from 'react';
import {
  View,
  Text,
  StyleSheet,
  ScrollView,
  TouchableOpacity,
  ActivityIndicator,
  Platform,
  AppState,
  Alert,
  Modal,
} from 'react-native';
import { useTranslation } from 'react-i18next';
import { usePermissions } from '../../context/PermissionContext';
import { AuthContext } from '../../context/AuthContext';
import { processQrCode } from '../../services/qrService';
import { colors, spacing, typography, shadows } from '../../theme';
import Logo from '../../components/Logo';

// Conditional import for expo-camera (web'de Ã§alÄ±ÅŸmaz)
let CameraView, CameraType;
let cameraModuleLoaded = false;

if (Platform.OS !== 'web') {
  try {
    const Camera = require('expo-camera');
    if (Camera && Camera.CameraView) {
      CameraView = Camera.CameraView;
      CameraType = Camera.CameraType;
      cameraModuleLoaded = true;
    }
  } catch (error) {
    console.warn('expo-camera could not be loaded:', error);
  }
}

/**
 * Payment Screen - QR Code Okuma
 * Tam izin yÃ¶netimi, QR kod iÅŸleme ve backend entegrasyonu
 */
const PaymentScreen = () => {
  const { t } = useTranslation();
  const {
    cameraPermissionStatus,
    isCameraActive,
    requestCameraPermission,
    checkCameraPermission,
    setIsCameraActive,
    hasAnyPermissionDenied,
    openSettings,
  } = usePermissions();
  const { userToken } = React.useContext(AuthContext);

  // State
  const [scanned, setScanned] = useState(false);
  const [processing, setProcessing] = useState(false);
  const [qrResult, setQrResult] = useState(null);
  const [showResultModal, setShowResultModal] = useState(false);
  const [appState, setAppState] = useState(AppState.currentState);

  // Refs
  const scanLockRef = useRef(false);

  // AppState deÄŸiÅŸikliÄŸini dinle (ayarlardan dÃ¶nÃ¼nce kontrol et)
  useEffect(() => {
    if (Platform.OS === 'web') return;

    const subscription = AppState.addEventListener('change', async (nextAppState) => {
      // Uygulama aktif hale geldiÄŸinde (ayarlardan dÃ¶nÃ¼nce)
      if (appState.match(/inactive|background/) && nextAppState === 'active') {
        // Ä°zinleri tekrar kontrol et
        setTimeout(async () => {
          await checkCameraPermission();
          // EÄŸer izin verildiyse kamera otomatik baÅŸlasÄ±n
          if (cameraPermissionStatus === 'granted') {
            setIsCameraActive(true);
          }
        }, 500);
      }
      setAppState(nextAppState);
    });

    return () => {
      subscription?.remove();
    };
  }, [appState, cameraPermissionStatus, checkCameraPermission, setIsCameraActive]);

  // Screen mount olduÄŸunda izinleri kontrol et
  useEffect(() => {
    if (Platform.OS === 'web') return;

    const checkPermissions = async () => {
      await checkCameraPermission();
      // Ä°zin verildiyse kamera otomatik baÅŸlat
      if (cameraPermissionStatus === 'granted') {
        setIsCameraActive(true);
      }
    };

    checkPermissions();
  }, []);

  // Ä°zin verildiÄŸinde kamera otomatik baÅŸlat
  useEffect(() => {
    if (cameraPermissionStatus === 'granted' && !isCameraActive) {
      setIsCameraActive(true);
    }
  }, [cameraPermissionStatus, isCameraActive, setIsCameraActive]);

  // QR kod okunduÄŸunda
  const handleBarCodeScanned = async ({ type, data }) => {
    // Lock mekanizmasÄ± - tekrar okutmayÄ± engelle
    if (scanLockRef.current || scanned || processing) {
      return;
    }

    scanLockRef.current = true;
    setScanned(true);
    setProcessing(true);

    try {
      console.log('QR Code scanned:', data);
      console.log('QR Code type:', type);

      // QR kod iÅŸleme servisi (mock/real ayrÄ±mÄ± otomatik)
      // userToken'dan userId Ã§Ä±karÄ±labilir veya getUserProfile servisi kullanÄ±labilir
      const result = await processQrCode(
        data,
        userToken || null, // userId - token'dan veya profile'dan alÄ±nabilir
        null // deviceId - gerekirse eklenebilir
      );

      if (result.success) {
        // BaÅŸarÄ±lÄ± - sonucu gÃ¶ster
        setQrResult(result);
        setShowResultModal(true);
        // Kamera geÃ§ici olarak durdur
        setIsCameraActive(false);
      } else {
        // Hata durumu
        Alert.alert(
          t('payment.error'),
          result.error || t('payment.qrProcessingError'),
          [
            {
              text: t('common.ok'),
              onPress: () => {
                // 2 saniye sonra tekrar taramaya izin ver
                setTimeout(() => {
                  setScanned(false);
                  scanLockRef.current = false;
                  setProcessing(false);
                }, 2000);
              },
            },
          ]
        );
      }
    } catch (error) {
      console.error('QR processing error:', error);
      Alert.alert(
        t('payment.error'),
        error.message || t('payment.qrProcessingError'),
        [
          {
            text: t('common.ok'),
            onPress: () => {
              setTimeout(() => {
                setScanned(false);
                scanLockRef.current = false;
                setProcessing(false);
              }, 2000);
            },
          },
        ]
      );
    }
  };

  // Yeni QR okut
  const handleNewScan = () => {
    setQrResult(null);
    setShowResultModal(false);
    setScanned(false);
    scanLockRef.current = false;
    setProcessing(false);
    setIsCameraActive(true);
  };

  // Ä°zin iste
  const handleRequestPermission = async () => {
    const result = await requestCameraPermission();
    if (result.granted) {
      setIsCameraActive(true);
    }
  };

  // Web iÃ§in placeholder
  if (Platform.OS === 'web') {
    return (
      <View style={styles.container}>
        <ScrollView contentContainerStyle={styles.scrollContent}>
          <View style={styles.logoContainer}>
            <Logo size="small" />
          </View>
          <View style={styles.content}>
            <Text style={styles.title}>{t('payment.scanQR')}</Text>
            <Text style={styles.subtitle}>{t('payment.scanQRSubtitle')}</Text>
            <Text style={styles.infoText}>{t('payment.scanQRInfo')}</Text>
          </View>
        </ScrollView>
      </View>
    );
  }

  // Kamera modÃ¼lÃ¼ yÃ¼klenmemiÅŸse
  if (!cameraModuleLoaded || !CameraView || !CameraType) {
    return (
      <View style={styles.container}>
        <ScrollView contentContainerStyle={styles.scrollContent}>
          <View style={styles.logoContainer}>
            <Logo size="small" />
          </View>
          <View style={styles.content}>
            <ActivityIndicator size="large" color={colors.primary} />
            <Text style={styles.infoText}>{t('payment.cameraModuleLoading')}</Text>
          </View>
        </ScrollView>
      </View>
    );
  }

  // Ä°zin verilmemiÅŸse
  if (cameraPermissionStatus !== 'granted') {
    const showSettingsButton = cameraPermissionStatus === 'denied';

    return (
      <View style={styles.container}>
        <ScrollView contentContainerStyle={styles.scrollContent}>
          <View style={styles.logoContainer}>
            <Logo size="small" />
          </View>
          <View style={styles.content}>
            <Text style={styles.title}>{t('payment.scanQR')}</Text>
            <Text style={styles.subtitle}>
              {cameraPermissionStatus === 'denied'
                ? t('payment.cameraPermissionDenied')
                : t('payment.cameraPermissionRequired')}
            </Text>

            {/* Ayarlara Git Butonu - denied durumunda veya herhangi bir izin eksikse */}
            {showSettingsButton && (
              <TouchableOpacity
                style={styles.settingsButton}
                onPress={openSettings}
                activeOpacity={0.7}
              >
                <Text style={styles.settingsButtonText}>{t('payment.openSettings')}</Text>
              </TouchableOpacity>
            )}

            {cameraPermissionStatus === 'undetermined' && (
              <TouchableOpacity
                style={styles.settingsButton}
                onPress={handleRequestPermission}
                activeOpacity={0.7}
              >
                <Text style={styles.settingsButtonText}>{t('payment.requestPermission')}</Text>
              </TouchableOpacity>
            )}

            <Text style={styles.infoText}>
              {showSettingsButton ? t('payment.settingsInfo') : t('payment.permissionInfo')}
            </Text>
          </View>
        </ScrollView>
      </View>
    );
  }

  // Kamera aktif deÄŸilse (QR sonrasÄ± durdurulmuÅŸ olabilir)
  if (!isCameraActive) {
    return (
      <View style={styles.container}>
        <ScrollView contentContainerStyle={styles.scrollContent}>
          <View style={styles.logoContainer}>
            <Logo size="small" />
          </View>
          <View style={styles.content}>
            <Text style={styles.title}>{t('payment.scanQR')}</Text>
            <TouchableOpacity
              style={styles.settingsButton}
              onPress={handleNewScan}
              activeOpacity={0.7}
            >
              <Text style={styles.settingsButtonText}>{t('payment.newScan')}</Text>
            </TouchableOpacity>
          </View>
        </ScrollView>
      </View>
    );
  }

  // Kamera aktif - QR tarama ekranÄ±
  return (
    <View style={styles.container}>
      <View style={styles.logoContainerAbsolute}>
        <Logo size="small" />
      </View>
      {processing && (
        <View style={styles.processingOverlay}>
          <ActivityIndicator size="large" color={colors.white} />
          <Text style={styles.processingText}>{t('payment.processing')}</Text>
        </View>
      )}
      <CameraView
        style={styles.camera}
        facing={CameraType.back}
        onBarcodeScanned={scanned || processing ? undefined : handleBarCodeScanned}
        barcodeScannerSettings={{
          barcodeTypes: ['qr'],
        }}
      >
        <View style={styles.overlay}>
          <View style={styles.scanArea}>
            <View style={styles.scanFrame} />
            <Text style={styles.scanInstruction}>{t('payment.scanInstruction')}</Text>
          </View>
        </View>
      </CameraView>

      {/* QR SonuÃ§ Modal */}
      <Modal
        visible={showResultModal}
        transparent={true}
        animationType="fade"
        onRequestClose={() => setShowResultModal(false)}
      >
        <View style={styles.modalOverlay}>
          <View style={styles.modalContent}>
            <View style={styles.resultHeader}>
              <Text style={styles.resultTitle}>{t('payment.paid')}</Text>
            </View>
            <View style={styles.resultBody}>
              {qrResult && (
                <>
                  <Text style={styles.resultMessage}>{qrResult.message}</Text>
                  <View style={styles.resultStats}>
                    <View style={styles.resultStatItem}>
                      <Text style={styles.resultStatLabel}>{t('payment.totalOrders')}</Text>
                      <Text style={styles.resultStatValue}>{qrResult.totalOrderCount}</Text>
                    </View>
                    <View style={styles.resultStatItem}>
                      <Text style={styles.resultStatLabel}>{t('payment.remainingForPromotion')}</Text>
                      <Text style={styles.resultStatValue}>{qrResult.remainingForPromotion}</Text>
                    </View>
                  </View>
                </>
              )}
            </View>
            <View style={styles.resultFooter}>
              <TouchableOpacity
                style={styles.resultButton}
                onPress={handleNewScan}
                activeOpacity={0.7}
              >
                <Text style={styles.resultButtonText}>{t('payment.newScan')}</Text>
              </TouchableOpacity>
            </View>
          </View>
        </View>
      </Modal>
    </View>
  );
};

const styles = StyleSheet.create({
  container: {
    flex: 1,
    backgroundColor: colors.background,
  },
  scrollContent: {
    padding: spacing.md,
  },
  logoContainer: {
    paddingBottom: spacing.sm,
  },
  logoContainerAbsolute: {
    position: 'absolute',
    top: spacing.md,
    left: spacing.md,
    right: spacing.md,
    zIndex: 10,
    alignItems: 'center',
  },
  content: {
    flex: 1,
    justifyContent: 'center',
    alignItems: 'center',
    padding: spacing.lg,
  },
  title: {
    fontSize: typography.fontSize.xxl,
    fontWeight: typography.fontWeight.bold,
    color: colors.textPrimary,
    marginBottom: spacing.sm,
    textAlign: 'center',
  },
  subtitle: {
    fontSize: typography.fontSize.md,
    color: colors.textSecondary,
    marginBottom: spacing.xl,
    textAlign: 'center',
  },
  settingsButton: {
    backgroundColor: colors.primary,
    paddingVertical: spacing.md,
    paddingHorizontal: spacing.xl,
    borderRadius: spacing.sm,
    minWidth: 200,
    alignItems: 'center',
    ...shadows.medium,
    marginBottom: spacing.md,
  },
  settingsButtonText: {
    color: colors.white,
    fontSize: typography.fontSize.md,
    fontWeight: typography.fontWeight.semibold,
  },
  infoText: {
    marginTop: spacing.lg,
    fontSize: typography.fontSize.sm,
    color: colors.textSecondary,
    textAlign: 'center',
    paddingHorizontal: spacing.md,
  },
  camera: {
    flex: 1,
  },
  overlay: {
    flex: 1,
    backgroundColor: 'transparent',
    justifyContent: 'center',
    alignItems: 'center',
  },
  scanArea: {
    width: 250,
    height: 250,
    justifyContent: 'center',
    alignItems: 'center',
  },
  scanFrame: {
    width: 250,
    height: 250,
    borderWidth: 2,
    borderColor: colors.primary,
    borderRadius: spacing.sm,
    backgroundColor: 'transparent',
  },
  scanInstruction: {
    marginTop: spacing.md,
    color: colors.white,
    fontSize: typography.fontSize.sm,
    textAlign: 'center',
    backgroundColor: 'rgba(0, 0, 0, 0.6)',
    padding: spacing.sm,
    borderRadius: spacing.sm,
  },
  processingOverlay: {
    position: 'absolute',
    top: 0,
    left: 0,
    right: 0,
    bottom: 0,
    backgroundColor: 'rgba(0, 0, 0, 0.7)',
    justifyContent: 'center',
    alignItems: 'center',
    zIndex: 100,
  },
  processingText: {
    marginTop: spacing.md,
    color: colors.white,
    fontSize: typography.fontSize.md,
    fontWeight: typography.fontWeight.semibold,
  },
  modalOverlay: {
    flex: 1,
    backgroundColor: 'rgba(0, 0, 0, 0.5)',
    justifyContent: 'center',
    alignItems: 'center',
    padding: spacing.lg,
  },
  modalContent: {
    backgroundColor: colors.surface,
    borderRadius: spacing.md,
    width: '90%',
    maxWidth: 400,
    ...shadows.large,
  },
  resultHeader: {
    padding: spacing.lg,
    borderBottomWidth: 1,
    borderBottomColor: colors.border,
    alignItems: 'center',
  },
  resultTitle: {
    fontSize: typography.fontSize.xxl,
    fontWeight: typography.fontWeight.bold,
    color: colors.primary,
  },
  resultBody: {
    padding: spacing.lg,
  },
  resultMessage: {
    fontSize: typography.fontSize.lg,
    fontWeight: typography.fontWeight.semibold,
    color: colors.textPrimary,
    textAlign: 'center',
    marginBottom: spacing.lg,
  },
  resultStats: {
    marginTop: spacing.md,
  },
  resultStatItem: {
    flexDirection: 'row',
    justifyContent: 'space-between',
    alignItems: 'center',
    paddingVertical: spacing.sm,
    borderBottomWidth: 1,
    borderBottomColor: colors.border,
  },
  resultStatLabel: {
    fontSize: typography.fontSize.md,
    color: colors.textSecondary,
  },
  resultStatValue: {
    fontSize: typography.fontSize.lg,
    fontWeight: typography.fontWeight.bold,
    color: colors.primary,
  },
  resultFooter: {
    padding: spacing.lg,
    borderTopWidth: 1,
    borderTopColor: colors.border,
  },
  resultButton: {
    backgroundColor: colors.primary,
    paddingVertical: spacing.md,
    paddingHorizontal: spacing.xl,
    borderRadius: spacing.sm,
    alignItems: 'center',
  },
  resultButtonText: {
    color: colors.white,
    fontSize: typography.fontSize.md,
    fontWeight: typography.fontWeight.semibold,
  },
});

export default PaymentScreen;


===========================================
2. PERMISSION CONTEXT
===========================================
Dosya: src/context/PermissionContext.js
Toplam SatÄ±r: 275
Not: Kamera izinleri bu context'ten yÃ¶netiliyor

import React, { createContext, useState, useEffect, useContext } from 'react';
import { Platform, AppState, Linking } from 'react-native';
import * as Location from 'expo-location';
import AsyncStorage from '@react-native-async-storage/async-storage';

// Conditional import for expo-camera (web'de Ã§alÄ±ÅŸmaz)
let useCameraPermissions;
if (Platform.OS !== 'web') {
  try {
    const Camera = require('expo-camera');
    useCameraPermissions = Camera.useCameraPermissions;
  } catch (error) {
    console.warn('expo-camera could not be loaded:', error);
  }
}

// Fallback hook for web
const fallbackCameraPermissions = () => {
  return [
    { granted: false, canAskAgain: false },
    async () => ({ granted: false, canAskAgain: false }),
  ];
};

if (!useCameraPermissions) {
  useCameraPermissions = fallbackCameraPermissions;
}

const PermissionContext = createContext();

export const PermissionProvider = ({ children }) => {
  // Camera permission hook - conditional
  const cameraPermissionHook = useCameraPermissions();
  const [cameraPermission, requestCameraPermission] = cameraPermissionHook || [
    { granted: false, canAskAgain: false },
    async () => ({ granted: false, canAskAgain: false }),
  ];
  
  // Camera permission state
  const [cameraPermissionStatus, setCameraPermissionStatus] = useState('undetermined'); // 'undetermined' | 'granted' | 'denied'
  const [isCameraActive, setIsCameraActive] = useState(false);

  // Location permission state
  const [locationPermissionStatus, setLocationPermissionStatus] = useState('undetermined'); // 'undetermined' | 'granted' | 'denied'

  // AppState tracking
  const [appState, setAppState] = useState(AppState.currentState);

  // Storage keys
  const CAMERA_PERMISSION_KEY = 'app_camera_permission_asked';
  const LOCATION_PERMISSION_KEY = 'app_location_permission_asked';

  /**
   * Camera permission durumunu kontrol et ve gÃ¼ncelle
   */
  const checkCameraPermission = async () => {
    if (Platform.OS === 'web') {
      setCameraPermissionStatus('denied');
      return;
    }

    try {
      if (!cameraPermission) {
        setCameraPermissionStatus('undetermined');
        return;
      }

      if (cameraPermission.granted === true) {
        setCameraPermissionStatus('granted');
        await AsyncStorage.setItem(CAMERA_PERMISSION_KEY, 'true');
      } else if (cameraPermission.canAskAgain === false) {
        setCameraPermissionStatus('denied');
      } else {
        setCameraPermissionStatus('undetermined');
      }
    } catch (error) {
      console.error('Camera permission check error:', error);
      setCameraPermissionStatus('undetermined');
    }
  };

  /**
   * Location permission durumunu kontrol et ve gÃ¼ncelle
   */
  const checkLocationPermission = async () => {
    if (Platform.OS === 'web') {
      setLocationPermissionStatus('denied');
      return;
    }

    try {
      const { status } = await Location.getForegroundPermissionsAsync();
      
      if (status === 'granted') {
        setLocationPermissionStatus('granted');
        await AsyncStorage.setItem(LOCATION_PERMISSION_KEY, 'true');
      } else if (status === 'denied') {
        setLocationPermissionStatus('denied');
      } else {
        setLocationPermissionStatus('undetermined');
      }
    } catch (error) {
      console.error('Location permission check error:', error);
      setLocationPermissionStatus('undetermined');
    }
  };

  /**
   * Camera permission iste
   */
  const requestCameraPermissionAsync = async () => {
    if (Platform.OS === 'web') {
      return { granted: false };
    }

    try {
      if (!requestCameraPermission) {
        return { granted: false };
      }

      const result = await requestCameraPermission();
      await checkCameraPermission();
      return result;
    } catch (error) {
      console.error('Camera permission request error:', error);
      return { granted: false };
    }
  };

  /**
   * Location permission iste
   */
  const requestLocationPermissionAsync = async () => {
    if (Platform.OS === 'web') {
      return { granted: false };
    }

    try {
      const { status } = await Location.requestForegroundPermissionsAsync();
      
      if (status === 'granted') {
        setLocationPermissionStatus('granted');
        await AsyncStorage.setItem(LOCATION_PERMISSION_KEY, 'true');
        return { granted: true };
      } else {
        setLocationPermissionStatus('denied');
        return { granted: false };
      }
    } catch (error) {
      console.error('Location permission request error:', error);
      setLocationPermissionStatus('undetermined');
      return { granted: false };
    }
  };

  /**
   * Ä°lk aÃ§Ä±lÄ±ÅŸta izinleri kontrol et ve iste
   */
  const initializePermissions = async () => {
    if (Platform.OS === 'web') return;

    try {
      // Ã–nce mevcut durumlarÄ± kontrol et
      await checkCameraPermission();
      await checkLocationPermission();

      // Storage'dan daha Ã¶nce izin istenip istenmediÄŸini kontrol et
      const cameraAsked = await AsyncStorage.getItem(CAMERA_PERMISSION_KEY);
      const locationAsked = await AsyncStorage.getItem(LOCATION_PERMISSION_KEY);

      // Ä°lk aÃ§Ä±lÄ±ÅŸta (storage'da yoksa) tÃ¼m izinleri otomatik iste
      if (!cameraAsked) {
        // KÄ±sa bir gecikme ile izin iste (UI hazÄ±r olsun)
        setTimeout(async () => {
          await requestCameraPermissionAsync();
        }, 500);
      }

      if (!locationAsked) {
        // KÄ±sa bir gecikme ile izin iste
        setTimeout(async () => {
          await requestLocationPermissionAsync();
        }, 1000);
      }
    } catch (error) {
      console.error('Permission initialization error:', error);
    }
  };

  /**
   * Ayarlara git
   */
  const openSettings = async () => {
    try {
      if (Platform.OS === 'ios') {
        await Linking.openURL('app-settings:');
      } else {
        await Linking.openSettings();
      }
    } catch (error) {
      console.error('Failed to open settings:', error);
    }
  };

  // Camera permission deÄŸiÅŸikliÄŸini dinle
  useEffect(() => {
    if (Platform.OS !== 'web') {
      checkCameraPermission();
    }
  }, [cameraPermission]);

  // Ä°lk mount'ta izinleri kontrol et ve iste
  useEffect(() => {
    if (Platform.OS !== 'web') {
      initializePermissions();
    }
  }, []);

  // AppState deÄŸiÅŸikliÄŸini dinle (ayarlardan dÃ¶nÃ¼nce kontrol et)
  useEffect(() => {
    if (Platform.OS === 'web') return;

    const subscription = AppState.addEventListener('change', async (nextAppState) => {
      // Uygulama aktif hale geldiÄŸinde (ayarlardan dÃ¶nÃ¼nce)
      if (appState.match(/inactive|background/) && nextAppState === 'active') {
        // KÄ±sa bir gecikme ile izinleri tekrar kontrol et
        setTimeout(async () => {
          await checkCameraPermission();
          await checkLocationPermission();
        }, 500);
      }
      setAppState(nextAppState);
    });

    return () => {
      subscription?.remove();
    };
  }, [appState]);

  const value = {
    // Camera
    cameraPermissionStatus,
    isCameraActive,
    requestCameraPermission: requestCameraPermissionAsync,
    checkCameraPermission,
    setIsCameraActive,
    
    // Location
    locationPermissionStatus,
    requestLocationPermission: requestLocationPermissionAsync,
    checkLocationPermission,
    
    // Settings
    openSettings,
    
    // Helpers
    hasAllPermissions: cameraPermissionStatus === 'granted' && locationPermissionStatus === 'granted',
    hasAnyPermissionDenied: cameraPermissionStatus === 'denied' || locationPermissionStatus === 'denied',
  };

  return (
    <PermissionContext.Provider value={value}>
      {children}
    </PermissionContext.Provider>
  );
};

export const usePermissions = () => {
  const context = useContext(PermissionContext);
  if (!context) {
    throw new Error('usePermissions must be used within PermissionProvider');
  }
  return context;
};


===========================================
3. QR SERVICE
===========================================
Dosya: src/services/qrService.js
Toplam SatÄ±r: 29

/**
 * QR Service - Mock / Real API Switch
 * QR kod iÅŸleme servisi - mock ve production modlarÄ± iÃ§in hazÄ±r
 */

import { USE_MOCK_API } from '../config/api';
import * as mockQrService from './mock/qrMockService';
import * as apiQrService from './api/qrApiService';

/**
 * Service switch - USE_MOCK_API flag'ine gÃ¶re mock veya real servis kullanÄ±r
 */
const getService = () => (USE_MOCK_API ? mockQrService : apiQrService);

/**
 * QR kod iÅŸleme fonksiyonu
 * Mock modda: simÃ¼le edilmiÅŸ response dÃ¶ner
 * Real modda: backend'e POST isteÄŸi gÃ¶nderir
 * 
 * @param {string} qrCodeData - QR koddan okunan veri
 * @param {string} userId - KullanÄ±cÄ± ID (AuthContext'ten alÄ±nacak)
 * @param {string} deviceId - Cihaz ID (opsiyonel)
 * @returns {Promise<{success: boolean, message: string, totalOrderCount: number, remainingForPromotion: number}>}
 */
export const processQrCode = async (qrCodeData, userId = null, deviceId = null) => {
  const service = getService();
  return await service.processQrCode(qrCodeData, userId, deviceId);
};


===========================================
4. QR API SERVICE (REAL)
===========================================
Dosya: src/services/api/qrApiService.js
Toplam SatÄ±r: 79

/**
 * QR API Service
 * Production modda gerÃ§ek backend entegrasyonu
 */

import { API_BASE_URL } from '../../config/api';

/**
 * QR kod iÅŸleme - Real API implementation
 * Backend'e POST isteÄŸi gÃ¶nderir
 * 
 * @param {string} qrCodeData - QR koddan okunan veri
 * @param {string} userId - KullanÄ±cÄ± ID
 * @param {string} deviceId - Cihaz ID
 * @returns {Promise<{success: boolean, message: string, totalOrderCount: number, remainingForPromotion: number}>}
 */
export const processQrCode = async (qrCodeData, userId = null, deviceId = null) => {
  try {
    // Backend endpoint
    const endpoint = `${API_BASE_URL}/api/qr/process`;

    // Request payload
    const payload = {
      qrCodeData,
      userId,
      deviceId,
    };

    // POST isteÄŸi
    const response = await fetch(endpoint, {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        // Authorization header eklenebilir
        // 'Authorization': `Bearer ${token}`,
      },
      body: JSON.stringify(payload),
    });

    const data = await response.json();

    // Backend response formatÄ±:
    // {
    //   success: boolean,
    //   message: string,
    //   totalOrderCount: number,
    //   remainingForPromotion: number
    // }

    if (!response.ok) {
      return {
        success: false,
        message: data.message || 'QR_PROCESSING_ERROR',
        error: data.error || 'QR kod iÅŸleme hatasÄ±',
        totalOrderCount: 0,
        remainingForPromotion: 0,
      };
    }

    return {
      success: data.success || false,
      message: data.message || 'UNKNOWN',
      totalOrderCount: data.totalOrderCount || 0,
      remainingForPromotion: data.remainingForPromotion || 0,
    };
  } catch (error) {
    console.error('QR API error:', error);
    
    // Network hatasÄ±
    return {
      success: false,
      message: 'NETWORK_ERROR',
      error: error.message || 'BaÄŸlantÄ± hatasÄ±',
      totalOrderCount: 0,
      remainingForPromotion: 0,
    };
  }
};


===========================================
5. QR MOCK SERVICE
===========================================
Dosya: src/services/mock/qrMockService.js
Toplam SatÄ±r: 39

/**
 * QR Mock Service
 * Mock modda QR kod iÅŸleme simÃ¼lasyonu
 */

/**
 * QR kod iÅŸleme - Mock implementation
 * GerÃ§ek backend'e gitmiÅŸ gibi simÃ¼le eder
 * 
 * @param {string} qrCodeData - QR koddan okunan veri
 * @param {string} userId - KullanÄ±cÄ± ID
 * @param {string} deviceId - Cihaz ID
 * @returns {Promise<{success: boolean, message: string, totalOrderCount: number, remainingForPromotion: number}>}
 */
export const processQrCode = async (qrCodeData, userId = null, deviceId = null) => {
  // Network gecikmesi simÃ¼le et (1-2 saniye)
  await new Promise((resolve) => setTimeout(resolve, 1500));

  // QR kod validasyonu (mock)
  if (!qrCodeData || qrCodeData.trim().length === 0) {
    return {
      success: false,
      message: 'INVALID_QR',
      error: 'GeÃ§ersiz QR kod',
      totalOrderCount: 0,
      remainingForPromotion: 0,
    };
  }

  // Mock response - baÅŸarÄ±lÄ± Ã¶deme
  // GerÃ§ek backend response formatÄ±na uygun
  return {
    success: true,
    message: 'PAID',
    totalOrderCount: 7,
    remainingForPromotion: 3,
  };
};


===========================================
6. NAVIGATION ENTEGRASYONU
===========================================
Dosya: src/navigation/BottomTabNavigator.js
PaymentScreen'in navigation'a nasÄ±l eklendiÄŸi

import React from 'react';
import { createBottomTabNavigator } from '@react-navigation/bottom-tabs';
import { Text } from 'react-native';
import { useTranslation } from 'react-i18next';
import { colors, typography } from '../theme';
import HomeScreen from '../screens/home/HomeScreen';
import BrowseScreen from '../screens/browse/BrowseScreen';
import PaymentScreen from '../screens/payment/PaymentScreen';
import ProfileScreen from '../screens/profile/ProfileScreen';

const Tab = createBottomTabNavigator();

/**
 * Bottom Tab Navigator
 * Ana Sayfa, GÃ¶z At, Ã–deme Yap, Profil sekmeleri
 */
const BottomTabNavigator = () => {
  const { t } = useTranslation();
  
  return (
    <Tab.Navigator
      screenOptions={{
        headerShown: false,
        tabBarActiveTintColor: colors.primary,
        tabBarInactiveTintColor: colors.textSecondary,
        tabBarStyle: {
          backgroundColor: colors.surface,
          borderTopWidth: 1,
          borderTopColor: colors.border,
          height: 60,
          paddingBottom: 8,
          paddingTop: 8,
        },
        tabBarLabelStyle: {
          fontSize: typography.fontSize.xs,
          fontWeight: typography.fontWeight.medium,
        },
      }}
    >
      <Tab.Screen
        name="Home"
        component={HomeScreen}
        options={{
          tabBarLabel: t('navigation.home'),
          tabBarIcon: ({ color, size }) => (
            <Text style={{ fontSize: size, color }}>ğŸ </Text>
          ),
        }}
      />
      <Tab.Screen
        name="Browse"
        component={BrowseScreen}
        options={{
          tabBarLabel: t('navigation.browse'),
          tabBarIcon: ({ color, size }) => (
            <Text style={{ fontSize: size, color }}>ğŸ”</Text>
          ),
        }}
      />
      <Tab.Screen
        name="Payment"
        component={PaymentScreen}
        options={{
          tabBarLabel: t('navigation.payment'),
          tabBarIcon: ({ color, size }) => (
            <Text style={{ fontSize: size, color }}>ğŸ’³</Text>
          ),
        }}
      />
      <Tab.Screen
        name="Profile"
        component={ProfileScreen}
        options={{
          tabBarLabel: t('navigation.profile'),
          tabBarIcon: ({ color, size }) => (
            <Text style={{ fontSize: size, color }}>ğŸ‘¤</Text>
          ),
        }}
      />
    </Tab.Navigator>
  );
};

export default BottomTabNavigator;


===========================================
7. Ã‡EVÄ°RÄ°LER (LOCALES)
===========================================

ENGLISH (en.json):
{
  "payment": {
    "title": "Payment",
    "scanQR": "Scan QR Code",
    "scanQRSubtitle": "QR code scanning is available on mobile devices.",
    "scanQRInfo": "You can scan QR codes by opening the app on your Android or iOS device.",
    "cameraPreparing": "Preparing camera...",
    "cameraModuleLoading": "Loading camera module...",
    "cameraPermissionDenied": "Camera permission denied. Please grant permission in settings.",
    "cameraPermissionRequired": "We need camera permission to scan QR codes",
    "openSettings": "Open Settings",
    "requestPermission": "Request Permission",
    "settingsInfo": "After enabling camera permission in settings, return to the app.",
    "permissionInfo": "After granting camera permission, you can scan QR codes.",
    "scanInstruction": "Place the QR code in this area",
    "selectPaymentMethod": "Select Payment Method",
    "cardNumber": "Card Number",
    "cardHolder": "Card Holder",
    "expiryDate": "Expiry Date",
    "cvv": "CVV",
    "pay": "Pay",
    "paymentSuccess": "Payment successful",
    "paymentError": "Payment failed",
    "newScan": "Scan New QR",
    "processing": "Processing...",
    "paid": "PAID",
    "totalOrders": "Total Orders",
    "remainingForPromotion": "Remaining for Promotion",
    "error": "Error",
    "qrProcessingError": "QR code processing error"
  }
}

TURKISH (tr.json):
{
  "payment": {
    "title": "Ã–deme Yap",
    "scanQR": "QR Kod Okut",
    "scanQRSubtitle": "QR kod tarama Ã¶zelliÄŸi mobil cihazlarda kullanÄ±labilir.",
    "scanQRInfo": "Android veya iOS cihazÄ±nÄ±zda uygulamayÄ± aÃ§arak QR kod okutabilirsiniz.",
    "cameraPreparing": "Kamera hazÄ±rlanÄ±yor...",
    "cameraModuleLoading": "Kamera modÃ¼lÃ¼ yÃ¼kleniyor...",
    "cameraPermissionDenied": "Kamera izni reddedilmiÅŸ. LÃ¼tfen ayarlardan izin verin.",
    "cameraPermissionRequired": "QR kod okutmak iÃ§in kamera iznine ihtiyacÄ±mÄ±z var",
    "openSettings": "Ayarlara Git",
    "requestPermission": "Ä°zin Ä°ste",
    "settingsInfo": "Ayarlardan kamera iznini aÃ§tÄ±ktan sonra uygulamaya geri dÃ¶nÃ¼n.",
    "permissionInfo": "Kamera izni verildikten sonra QR kod okutabilirsiniz.",
    "scanInstruction": "QR kodu bu alana yerleÅŸtirin",
    "selectPaymentMethod": "Ã–deme YÃ¶ntemi SeÃ§in",
    "cardNumber": "Kart NumarasÄ±",
    "cardHolder": "Kart Sahibi",
    "expiryDate": "Son Kullanma Tarihi",
    "cvv": "CVV",
    "pay": "Ã–de",
    "paymentSuccess": "Ã–deme baÅŸarÄ±lÄ±",
    "paymentError": "Ã–deme baÅŸarÄ±sÄ±z",
    "newScan": "Yeni QR Okut",
    "processing": "Ä°ÅŸleniyor...",
    "paid": "Ã–DENDÄ°",
    "totalOrders": "Toplam SipariÅŸ",
    "remainingForPromotion": "Promosyon Ä°Ã§in Kalan",
    "error": "Hata",
    "qrProcessingError": "QR kod iÅŸleme hatasÄ±"
  }
}


===========================================
KAMERA AÃ‡ILMAMA SORUNU Ä°Ã‡Ä°N Ä°NCELENMESÄ° GEREKENLER
===========================================

1. CAMERA MODULE LOADING (PaymentScreen.js SatÄ±r 21-36)
   - Platform.OS !== 'web' kontrolÃ¼
   - expo-camera require() hatasÄ± olabilir
   - CameraView ve CameraType undefined olabilir
   - cameraModuleLoaded false kalabilir
   
   DEBUG: console.log('cameraModuleLoaded:', cameraModuleLoaded);
   DEBUG: console.log('CameraView:', CameraView);
   DEBUG: console.log('CameraType:', CameraType);

2. CAMERA PERMISSION STATUS (PaymentScreen.js SatÄ±r 235-280)
   - cameraPermissionStatus !== 'granted' kontrolÃ¼
   - PermissionContext'ten gelen status doÄŸru mu?
   - 'undetermined', 'granted', 'denied' durumlarÄ±
   
   DEBUG: console.log('cameraPermissionStatus:', cameraPermissionStatus);

3. CAMERA ACTIVE STATE (PaymentScreen.js SatÄ±r 283-303)
   - isCameraActive false ise kamera aÃ§Ä±lmaz
   - setIsCameraActive(true) Ã§aÄŸrÄ±lÄ±yor mu?
   - useEffect'ler doÄŸru Ã§alÄ±ÅŸÄ±yor mu?
   
   DEBUG: console.log('isCameraActive:', isCameraActive);

4. PERMISSION CONTEXT Ä°NCELEMESÄ° (PermissionContext.js)
   - useCameraPermissions hook Ã§alÄ±ÅŸÄ±yor mu?
   - checkCameraPermission() doÄŸru Ã§alÄ±ÅŸÄ±yor mu?
   - setIsCameraActive() fonksiyonu doÄŸru Ã§alÄ±ÅŸÄ±yor mu?
   - cameraPermission.granted deÄŸeri doÄŸru mu?
   
   DEBUG: console.log('cameraPermission:', cameraPermission);
   DEBUG: console.log('cameraPermission.granted:', cameraPermission?.granted);

5. EXPO-CAMERA SDK 51 UYUMLULUÄU
   - expo-camera@15.0.16 SDK 51 ile uyumlu mu?
   - CameraView API deÄŸiÅŸmiÅŸ olabilir
   - useCameraPermissions hook API deÄŸiÅŸmiÅŸ olabilir
   
   KONTROL: package.json'da expo-camera versiyonu
   KONTROL: Expo SDK 51 dokÃ¼mantasyonunda CameraView API

6. ANDROID MANIFEST PERMISSIONS
   - android/app/src/main/AndroidManifest.xml
   - CAMERA permission tanÄ±mlÄ± mÄ±?
   - <uses-permission android:name="android.permission.CAMERA" />
   
   KONTROL: AndroidManifest.xml dosyasÄ±nÄ± kontrol et

7. iOS INFO.PLIST PERMISSIONS
   - ios/Lucky Table/Info.plist
   - NSCameraUsageDescription tanÄ±mlÄ± mÄ±?
   
   KONTROL: Info.plist dosyasÄ±nÄ± kontrol et

8. USEEFFECT BAÄIMLILIKLARI
   - PaymentScreen.js SatÄ±r 87: useEffect dependency array
   - cameraPermissionStatus deÄŸiÅŸtiÄŸinde useEffect tetikleniyor mu?
   - isCameraActive deÄŸiÅŸtiÄŸinde useEffect tetikleniyor mu?

9. APPSTATE DEÄÄ°ÅÄ°KLÄ°KLERÄ°
   - AppState.addEventListener doÄŸru Ã§alÄ±ÅŸÄ±yor mu?
   - Ayarlardan dÃ¶nÃ¼nce izin kontrolÃ¼ yapÄ±lÄ±yor mu?

10. EXPO-CAMERA IMPORT HATASI
    - require('expo-camera') baÅŸarÄ±sÄ±z olabilir
    - try-catch bloÄŸu hatayÄ± yakalÄ±yor mu?
    - console.warn mesajlarÄ± gÃ¶rÃ¼nÃ¼yor mu?


===========================================
Ã–NERÄ°LEN DEBUG ADIMLARI
===========================================

1. PaymentScreen.js'e console.log ekle:
   - SatÄ±r 32 sonrasÄ±: console.log('Camera module loaded:', cameraModuleLoaded);
   - SatÄ±r 53 sonrasÄ±: console.log('Permission status:', cameraPermissionStatus);
   - SatÄ±r 53 sonrasÄ±: console.log('Camera active:', isCameraActive);
   - SatÄ±r 106 sonrasÄ±: console.log('Permission granted, setting camera active');

2. PermissionContext.js'e console.log ekle:
   - SatÄ±r 68 sonrasÄ±: console.log('Camera permission granted:', cameraPermission.granted);
   - SatÄ±r 121 sonrasÄ±: console.log('Request result:', result);
   - SatÄ±r 208 sonrasÄ±: console.log('Camera permission changed:', cameraPermission);

3. Expo Camera versiyonu kontrol:
   - package.json'da expo-camera versiyonu: ~15.0.16
   - SDK 51 ile uyumlu versiyon kullanÄ±lÄ±yor mu?

4. AndroidManifest.xml kontrol:
   - CAMERA permission var mÄ±?
   - android/app/src/main/AndroidManifest.xml dosyasÄ±nÄ± kontrol et

5. React Native Debugger kullan:
   - Redux DevTools ile state deÄŸiÅŸikliklerini izle
   - Network tab ile API Ã§aÄŸrÄ±larÄ±nÄ± kontrol et

6. Expo DevTools kullan:
   - expo start --dev-client
   - Console loglarÄ± kontrol et


===========================================
POTANSÄ°YEL SORUNLAR VE Ã‡Ã–ZÃœMLER
===========================================

SORUN 1: cameraModuleLoaded false
Ã‡Ã–ZÃœM: 
- expo-camera paketinin yÃ¼klÃ¼ olduÄŸundan emin ol
- npm install expo-camera@~15.0.16
- require('expo-camera') hatasÄ± varsa, paket yÃ¼klÃ¼ deÄŸil demektir

SORUN 2: cameraPermissionStatus 'undetermined' kalÄ±yor
Ã‡Ã–ZÃœM:
- PermissionContext'te checkCameraPermission() Ã§aÄŸrÄ±lÄ±yor mu?
- useCameraPermissions hook Ã§alÄ±ÅŸÄ±yor mu?
- AndroidManifest.xml'de CAMERA permission var mÄ±?

SORUN 3: isCameraActive false kalÄ±yor
Ã‡Ã–ZÃœM:
- setIsCameraActive(true) Ã§aÄŸrÄ±lÄ±yor mu?
- useEffect dependency array'leri doÄŸru mu?
- cameraPermissionStatus === 'granted' kontrolÃ¼ doÄŸru mu?

SORUN 4: CameraView render edilmiyor
Ã‡Ã–ZÃœM:
- cameraModuleLoaded true mu?
- CameraView undefined mÄ±?
- CameraType undefined mÄ±?
- Expo SDK 51'de CameraView API deÄŸiÅŸmiÅŸ olabilir

SORUN 5: Permission istenmiyor
Ã‡Ã–ZÃœM:
- PermissionContext'te initializePermissions() Ã§aÄŸrÄ±lÄ±yor mu?
- requestCameraPermissionAsync() Ã§alÄ±ÅŸÄ±yor mu?
- AndroidManifest.xml'de permission tanÄ±mlÄ± mÄ±?


===========================================
SONUÃ‡
===========================================

Bu dosya PaymentScreen ile ilgili tÃ¼m kodlarÄ± iÃ§ermektedir.
Kamera aÃ§Ä±lmama sorunu iÃ§in yukarÄ±daki kontrol listesini takip edin.

Ã–ncelikli kontrol noktalarÄ±:
1. cameraModuleLoaded deÄŸiÅŸkeni
2. cameraPermissionStatus durumu
3. isCameraActive state'i
4. Expo Camera SDK 51 uyumluluÄŸu
5. Android/iOS manifest permissions

Dosya oluÅŸturulma tarihi: 2025-01-11
Proje: Lucky Table Mobile UI
Expo SDK: 51.0.0

